<!DOCTYPE html>
<html lang="vi">

<head>
  <th:block th:replace="~{user/_meta}" />
  <title>Đổi mật khẩu</title>
  <script th:src="@{/js/toast.js}" type="module"></script>
  <script th:src="@{/js/home.js}" type="module"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
<th:block th:replace="~{user/_header}" />

<section class="section-pagetop bg-light">
  <div class="container">
    <h2 class="title-page">Đổi mật khẩu</h2>
  </div> <!-- container.// -->
</section> <!-- section-pagetop.// -->

<section class="section-content padding-y">
  <div class="container">
    <div class="row">
          <th:block th:insert="~{user/navPanel :: nav(active='CHANGE_PASSWORD')}"></th:block>

          <main class="col-md-9">
            <article class="card">
              <div class="card-body">
                <div th:if="${successMessage}"  class="alert alert-success" role="alert" th:text="${successMessage}"></div>
                <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
                <div class="col-lg-6">
                  <form th:action="@{/changePassword}" method="post" autocomplete="off" id="passwordChangeForm">
                    <div class="mb-3">
                      <label for="inputCurrentPassword" class="form-label">
                        Nhập mật khẩu hiện tại
                      </label>
                      <div class="input-group">
                        <input type="password"
                               class="form-control"
                               id="inputCurrentPassword"
                               th:value="${currentPassword}"
                               name="currentPassword" required>
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="inputCurrentPassword">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="inputNewPassword" class="form-label">
                        Nhập mật khẩu mới
                      </label>
                      <div class="input-group">
                        <input type="password"
                               class="form-control"
                               id="inputNewPassword"
                               th:value="${newPassword}"
                               name="newPassword" required
                               pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$">
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="inputNewPassword">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <div class="password-strength mt-2">
                        <div class="progress" style="height: 5px;">
                          <div class="progress-bar" role="progressbar" style="width: 0%;" id="password-strength-bar"></div>
                        </div>
                        <small class="form-text text-muted" id="password-strength-text">Mật khẩu phải có ít nhất 8 ký tự</small>
                      </div>
                      <small class="form-text text-muted">
                        Mật khẩu phải chứa ít nhất 8 ký tự, gồm chữ hoa, chữ thường, số và ký tự đặc biệt
                      </small>
                    </div>
                    <div class="mb-3">
                      <label for="inputNewPasswordAgain" class="form-label">
                        Nhập mật khẩu mới một lần nữa
                      </label>
                      <div class="input-group">
                        <input type="password"
                               class="form-control"
                               id="inputNewPasswordAgain"
                               th:value="${newPasswordAgain}"
                               name="newPasswordAgain" required>
                        <button class="btn btn-outline-secondary toggle-password" type="button" data-target="inputNewPasswordAgain">
                          <i class="fas fa-eye"></i>
                        </button>
                      </div>
                      <div class="invalid-feedback" id="password-match-feedback">
                        Mật khẩu nhập lại không khớp
                      </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="submitButton" disabled>Đổi mật khẩu</button>
                  </form>
                </div>
              </div> <!-- card-body.// -->
            </article>
          </main> <!-- col.// -->
    </div> <!-- row.// -->
  </div> <!-- container.// -->
</section> <!-- section-content.// -->

<th:block th:replace="~{user/_footer}" />

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle password visibility
  document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (input.type === 'password') {
        input.type = 'text';
        this.innerHTML = '<i class="fas fa-eye-slash"></i>';
      } else {
        input.type = 'password';
        this.innerHTML = '<i class="fas fa-eye"></i>';
      }
    });
  });
  
  // Password strength check
  const newPassword = document.getElementById('inputNewPassword');
  const confirmPassword = document.getElementById('inputNewPasswordAgain');
  const strengthBar = document.getElementById('password-strength-bar');
  const strengthText = document.getElementById('password-strength-text');
  const submitButton = document.getElementById('submitButton');
  const matchFeedback = document.getElementById('password-match-feedback');
  
  function checkPasswordStrength(password) {
    let strength = 0;
    
    if (password.length >= 8) strength += 25;
    if (password.match(/[a-z]+/)) strength += 25;
    if (password.match(/[A-Z]+/)) strength += 25;
    if (password.match(/[0-9]+/)) strength += 12.5;
    if (password.match(/[$@#&!]+/)) strength += 12.5;
    
    return strength;
  }
  
  function updateStrengthBar() {
    const password = newPassword.value;
    const strength = checkPasswordStrength(password);
    
    strengthBar.style.width = strength + '%';
    
    if (strength < 50) {
      strengthBar.className = 'progress-bar bg-danger';
      strengthText.textContent = 'Mật khẩu yếu';
      strengthText.className = 'form-text text-danger';
    } else if (strength < 75) {
      strengthBar.className = 'progress-bar bg-warning';
      strengthText.textContent = 'Mật khẩu trung bình';
      strengthText.className = 'form-text text-warning';
    } else {
      strengthBar.className = 'progress-bar bg-success';
      strengthText.textContent = 'Mật khẩu mạnh';
      strengthText.className = 'form-text text-success';
    }
    
    validateForm();
  }
  
  function checkPasswordMatch() {
    if (confirmPassword.value && newPassword.value !== confirmPassword.value) {
      confirmPassword.classList.add('is-invalid');
      matchFeedback.style.display = 'block';
      return false;
    } else {
      confirmPassword.classList.remove('is-invalid');
      matchFeedback.style.display = 'none';
      return true;
    }
  }
  
  function validateForm() {
    const currentPasswordValid = document.getElementById('inputCurrentPassword').value.length > 0;
    const newPasswordValid = checkPasswordStrength(newPassword.value) >= 75;
    const passwordsMatch = checkPasswordMatch();
    
    submitButton.disabled = !(currentPasswordValid && newPasswordValid && passwordsMatch);
  }
  
  newPassword.addEventListener('input', updateStrengthBar);
  confirmPassword.addEventListener('input', checkPasswordMatch);
  document.getElementById('inputCurrentPassword').addEventListener('input', validateForm);
  
  document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
    if (!checkPasswordMatch()) {
      e.preventDefault();
      alert('Mật khẩu nhập lại không khớp!');
    }
  });
});
</script>
</body>

</html>
