<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<th:block th:replace="~{user/_meta}" />
	<title>Bán hàng tại quầy</title>
</head>

<body class="bg-light">
	<th:block th:replace="~{admin/_headerAdmin}" />

	<style>
		.pos-shell {
			display: flex;
			gap: 1rem;
			align-items: stretch;
		}

		.pos-left {
			flex: 1 1 auto;
			min-width: 0;
			display: flex;
			flex-direction: column;
		}

		.pos-right {
			width: 380px;
			flex: 0 0 auto;
			display: flex;
			flex-direction: column;
		}

		@media (max-width: 1200px) {
			.pos-right {
				width: 340px;
			}
		}

		@media (max-width: 992px) {
			.pos-shell {
				flex-direction: column;
			}

			.pos-right {
				width: 100%;
				order: -1;
			}
		}

		.product-grid {
			display: grid;
			gap: .75rem;
			grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
		}

		.product-card {
			border: 1px solid var(--color-border);
			border-radius: var(--radius);
			background: #fff;
			position: relative;
			overflow: hidden;
			cursor: pointer;
			display: flex;
			flex-direction: column;
		}

		.product-card img {
			width: 100%;
			height: 110px;
			object-fit: cover;
		}

		.product-card h6 {
			font-size: .8rem;
			font-weight: 600;
			margin: .25rem 0 .25rem;
			line-height: 1.2;
		}

		.product-card .meta {
			font-size: .65rem;
			color: var(--color-muted);
			line-height: 1.2;
		}

		.product-card .price-new {
			font-weight: 600;
			color: var(--color-primary);
		}

		.product-card .badge-stock {
			position: absolute;
			top: .4rem;
			right: .4rem;
		}

		.product-card.added-animate {
			animation: pulseAdd .5s;
		}

		@keyframes pulseAdd {
			0% {
				box-shadow: 0 0 0 0 rgba(var(--color-primary-rgb), .5);
			}

			100% {
				box-shadow: 0 0 0 12px rgba(var(--color-primary-rgb), 0);
			}
		}

		.fade-out-row {
			animation: fadeOut .45s forwards;
		}

		@keyframes fadeOut {
			to {
				opacity: 0;
				transform: translateX(6px);
			}
		}

		.row-highlight {
			animation: hiLite 1.2s;
		}

		@keyframes hiLite {
			0% {
				background: #fffbdc;
			}

			100% {
				background: transparent;
			}
		}

		.section-label {
			font-size: .65rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: .05em;
			color: var(--color-muted);
			margin-bottom: .25rem;
		}

		.cart-table thead th {
			font-size: .65rem;
			text-transform: uppercase;
			letter-spacing: .05em;
		}

		.voucher-box-success {
			animation: popScale .4s;
		}

		@keyframes popScale {
			0% {
				transform: scale(.95);
			}

			100% {
				transform: scale(1);
			}
		}
	</style>

	<div class="container-fluid px-4 py-3">
		<div class="d-flex align-items-center mb-3 gap-2 flex-wrap">
			<h5 class="mb-0">Bán hàng tại quầy</h5>
			<div class="ms-auto d-flex gap-2">
				<a th:if="${idHoaDon != null}" th:href="@{/admin/hoadon/print/{id}(id=${idHoaDon})}" target="_blank"
					class="btn btn-soft-primary btn-sm"><i class="fas fa-print me-1"></i> In hóa đơn</a>
			</div>
		</div>

		<div class="flash-container" th:if="${successMessage != null or errorMessage != null}">
			<div th:if="${successMessage}" class="alert alert-success py-2 px-3 d-flex align-items-center gap-2 mb-2">
				<i class="fas fa-check-circle"></i><span th:text="${successMessage}"></span>
			</div>
			<div th:if="${errorMessage}" class="alert alert-danger py-2 px-3 d-flex align-items-center gap-2 mb-2">
				<i class="fas fa-exclamation-circle"></i><span th:text="${errorMessage}"></span>
			</div>
		</div>

		<div class="pos-shell">
			<!-- LEFT PANEL: Products -->
			<div class="pos-left">
				<div class="card-elevated p-3 mb-3">
					<form method="get" th:action="@{/banhangtaiquay}" class="row g-2 align-items-end">
						<div class="col-auto">
							<label class="form-section-title mb-1">Từ khóa</label>
							<input type="text" name="keyword" class="form-control form-control-sm"
								placeholder="Tên sản phẩm" th:value="${keyword}">
						</div>
						<div class="col-auto">
							<label class="form-section-title mb-1">Loại</label>
							<select class="form-select form-select-sm" name="idLoai">
								<option value="" th:selected="${idLoai == null}">Tất cả</option>
								<option th:each="loai : ${dsLoai}" th:value="${loai.idLoai}" th:text="${loai.tenLoai}"
									th:selected="${idLoai == loai.idLoai}"></option>
							</select>
						</div>
						<div class="col-auto">
							<button class="btn btn-primary btn-sm mt-3"><i class="fas fa-search me-1"></i>Tìm</button>
						</div>
					</form>
				</div>

				<div id="product-list-area" class="card-elevated p-3 flex-grow-1 d-flex flex-column">
					<div class="product-grid mb-3">
						<div th:each="sp : ${dsSanPham.content}" class="product-card clickable-card-body"
							th:attr="data-tonkho=${sp.soluong},data-idsanpham=${sp.idSanpham}">
							<img th:src="@{/image/{url}(url=${sp.hinh})}" loading="lazy" />
							<div class="p-2 d-flex flex-column flex-grow-1">
								<h6 th:text="${sp.tenSanpham}"></h6>
								<div class="meta mb-1">Kho: <strong th:text="${sp.soluong}"></strong></div>
								<div class="mt-auto">
									<div class="meta">Giá: <strong
											th:text="${#numbers.formatInteger(sp.gia, 0, 'COMMA')} + '₫'"></strong>
									</div>
									<div th:if="${sp.giamgia > 0}" class="meta"><span class="text-danger">Giảm <strong
												th:text="${sp.giamgia + '%'}"></strong></span></div>
									<div th:if="${sp.soluong == 0}"
										class="badge badge-soft-danger badge-xs badge-stock">Hết hàng</div>
								</div>
							</div>
						</div>
					</div>
					<!-- pagination -->
					<div class="mt-auto pt-2">
						<nav th:if="${dsSanPham.totalPages > 1}">
							<ul class="pagination pagination-sm mb-0">
								<li class="page-item" th:classappend="${dsSanPham.first} ? 'disabled'">
									<a class="page-link"
										th:href="@{/banhangtaiquay(page=${dsSanPham.number - 1}, keyword=${keyword}, idLoai=${idLoai})}">«</a>
								</li>
								<li class="page-item" th:each="i : ${#numbers.sequence(0, dsSanPham.totalPages - 1)}"
									th:classappend="${i == dsSanPham.number} ? 'active'">
									<a class="page-link"
										th:href="@{/banhangtaiquay(page=${i}, keyword=${keyword}, idLoai=${idLoai})}"
										th:text="${i + 1}"></a>
								</li>
								<li class="page-item" th:classappend="${dsSanPham.last} ? 'disabled'">
									<a class="page-link"
										th:href="@{/banhangtaiquay(page=${dsSanPham.number + 1}, keyword=${keyword}, idLoai=${idLoai})}">»</a>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>

			<!-- RIGHT PANEL: Cart & Checkout -->
			<div class="pos-right">
				<div class="card-elevated p-3 mb-3 d-flex flex-column flex-grow-1" style="max-height:100%;">
					<div class="d-flex align-items-center mb-2">
						<h6 class="mb-0">Hóa đơn tạm</h6>
						<div class="ms-auto small text-muted" id="cartItemCount"></div>
					</div>
					<div class="mb-3">
						<div class="section-label">Voucher</div>
						<div class="input-group input-group-sm">
							<input type="text" class="form-control" id="voucherCodeInput" placeholder="Nhập mã..."
								autocomplete="off">
							<button type="button" class="btn btn-outline-secondary" id="applyVoucherBtn"><i
									class="fas fa-ticket-alt"></i></button>
							<button type="button" class="btn btn-outline-danger d-none" id="removeVoucherBtn"><i
									class="fas fa-times"></i></button>
						</div>
						<div id="voucherFeedback" class="small mt-1 text-muted"></div>
					</div>
					<div id="cart-area" class="flex-grow-1 overflow-auto mb-3">
						<table class="table table-sm table-modern cart-table">
							<thead>
								<tr>
									<th>Sản phẩm</th>
									<th class="text-center">SL</th>
									<th class="text-center">Giảm (%)</th>
									<th class="text-end">Giá</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="ct : ${gioHang}">
									<td th:text="${ct.sanPham.tenSanpham}"></td>
									<td class="text-center" th:text="${ct.soluong}"></td>
									<td class="discount-cell text-center">0%</td>
									<td class="text-end"
										th:text="${#numbers.formatInteger((ct.sanPham.gia * (100 - ct.sanPham.giamgia) / 100) * ct.soluong, 0, 'COMMA')} + '₫'">
									</td>
									<td class="text-end">
										<form th:action="@{/giohang/xoa}" method="post" class="d-inline">
											<input type="hidden" name="idSanpham" th:value="${ct.sanPham.idSanpham}">
											<button class="btn btn-soft-danger btn-sm" title="Xóa"><i
													class="fas fa-trash"></i></button>
										</form>
									</td>
								</tr>
								<tr th:if="${!#lists.isEmpty(gioHang)}" class="table-active">
									<td colspan="3" class="text-end fw-semibold">Tổng cộng:</td>
									<td class="fw-semibold text-danger text-end"
										th:text="${#numbers.formatInteger(tongCong, 0, 'COMMA')} + '₫'"></td>
									<td></td>
								</tr>
								<tr id="rowTongGiam">
									<td colspan="3" class="text-end fw-semibold">Tổng giảm:</td>
									<td class="fw-semibold text-danger text-end" id="tongGiam">0₫ (0%)</td>
									<td></td>
								</tr>
								<tr id="rowTongTienSauGiam">
									<td colspan="3" class="text-end fw-semibold">Sau giảm:</td>
									<td class="fw-semibold text-success text-end" id="tongTienSauGiam">0₫</td>
									<td></td>
								</tr>
								<tr th:if="${#lists.isEmpty(gioHang)}">
									<td colspan="5" class="text-center text-muted py-4">Chưa có sản phẩm</td>
								</tr>
							</tbody>
						</table>
					</div>

					<div class="mb-3">
						<div class="section-label">Thanh toán</div>
						<div class="d-flex gap-3">
							<div class="form-check">
								<input class="form-check-input" type="radio" id="CASH" name="phuongthuc" value="CASH"
									checked>
								<label for="CASH" class="form-check-label">Tiền mặt</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" id="BANK" type="radio" name="phuongthuc" value="BANK">
								<label for="BANK" class="form-check-label">Chuyển khoản</label>
							</div>
						</div>
					</div>

					<div class="mb-3">
						<div class="section-label">Khách hàng (SĐT)</div>
						<div class="input-group input-group-sm">
							<input type="text" class="form-control" id="searchKhachHangInput" placeholder="Nhập SĐT...">
							<button class="btn btn-outline-primary" type="button" id="createKhachHangBtn"><i
									class="fas fa-user-plus"></i></button>
						</div>
						<div id="khachHangResult" class="mt-2 small"></div>
					</div>

					<div class="mb-3">
						<div class="section-label">Giảm giá hóa đơn (%)</div>
						<input type="number" class="form-control form-control-sm" id="adminDiscountInput"
							name="adminDiscount" min="0" max="100" placeholder="% hoặc để trống auto">
					</div>

					<form th:action="@{/banhangtaiquay/thanh-toan}" method="post" class="mt-auto">
						<input type="hidden" name="phuongthuc" value="CASH" id="selectedPayment">
						<input type="hidden" name="khachHangId" id="selectedKhachHangId">
						<input type="hidden" name="adminDiscount" id="adminDiscountHidden">
						<input type="hidden" name="voucherCode" id="voucherCodeHidden">
						<input type="hidden" name="voucherDiscount" id="voucherDiscountHidden">
						<button type="submit" class="btn btn-primary w-100"><i class="fas fa-check-circle me-1"></i>
							Thanh toán</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal nhập số lượng -->
	<div class="modal fade" id="quantityModal" tabindex="-1" aria-labelledby="quantityModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="quantityModalLabel">Nhập số lượng</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="number" id="modalQuantity" class="form-control" value="1" min="1" autofocus />
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="confirmQuantity">Thêm</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal tạo khách hàng mới -->
	<div class="modal fade" id="createKhachHangModal" tabindex="-1" aria-labelledby="createKhachHangModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="createKhachHangModalLabel">Tạo khách hàng mới</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="createKhachHangForm">
						<div class="mb-3">
							<label class="form-label">Họ tên</label>
							<input type="text" class="form-control" name="hoten" required>
						</div>
						<div class="mb-3">
							<label class="form-label">Số điện thoại</label>
							<input type="text" class="form-control" name="sdt" required>
						</div>
						<button type="submit" class="btn btn-success">Tạo mới</button>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script>
		const radios = document.querySelectorAll('input[name="phuongthuc"]');
		const hiddenInput = document.getElementById('selectedPayment');
		radios.forEach(radio => {
			radio.addEventListener('change', () => {
				hiddenInput.value = radio.value;
			});
		});

		document.addEventListener('DOMContentLoaded', function () {
			console.log('DOMContentLoaded');
			let clickTimer = null;
			let lastProductId = null;
			const cardBodies = document.querySelectorAll('.clickable-card-body');
			const quantityModal = new bootstrap.Modal(document.getElementById('quantityModal'));
			const modalQuantity = document.getElementById('modalQuantity');
			const confirmQuantity = document.getElementById('confirmQuantity');

			cardBodies.forEach(cardBody => {
				const card = cardBody.closest('.product-card');
				cardBody.addEventListener('click', function (e) {
					const danger = card.querySelector('.text-danger');
					if (danger && danger.textContent.includes('Hết hàng')) return;
					if (e.target.closest('form,button,input')) return;
					if (clickTimer) clearTimeout(clickTimer);
					clickTimer = setTimeout(() => {
						card.classList.add('added-animate');
						setTimeout(() => card.classList.remove('added-animate'), 500);
						const idSanphamForClick = cardBody.getAttribute('data-idsanpham');
						fetch('/giohang/them', {
							method: 'POST',
							headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
							body: `idSanpham=${idSanphamForClick}&soluong=1`
						})
							.then(res => {
								if (res.ok) showErrorToast('Đã thêm vào giỏ!');
								else showErrorToast('Thêm vào giỏ thất bại!');
							})
							.catch(() => showErrorToast('Lỗi kết nối!'));
					}, 250);
				});
				cardBody.addEventListener('dblclick', function (e) {
					const danger = card.querySelector('.text-danger');
					if (danger && danger.textContent.includes('Hết hàng')) return;
					if (e.target.closest('form,button,input')) return;
					if (clickTimer) clearTimeout(clickTimer);
					lastProductId = cardBody.getAttribute('data-idsanpham');
					modalQuantity.value = 1;
					quantityModal.show();
					setTimeout(() => { modalQuantity.focus(); }, 300);
				});
			});
			confirmQuantity.addEventListener('click', function () {
				if (!lastProductId) return;
				const cardBody = document.querySelector(`.clickable-card-body[data-idsanpham="${lastProductId}"]`);
				if (!cardBody) return;
				const tonkho = parseInt(cardBody.getAttribute('data-tonkho'));
				const sl = parseInt(modalQuantity.value);
				if (sl > tonkho) { showErrorToast('Số lượng vượt quá tồn kho!'); return; }
				fetch('/giohang/them', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: `idSanpham=${lastProductId}&soluong=${sl}`
				})
					.then(res => {
						if (res.ok) { showErrorToast('Đã thêm vào giỏ!'); reloadCartFragment(); }
						else showErrorToast('Thêm vào giỏ thất bại!');
					})
					.catch(() => showErrorToast('Lỗi kết nối!'))
					.finally(() => { quantityModal.hide(); lastProductId = null; });
			});
			// Enter để xác nhận
			modalQuantity.addEventListener('keydown', function (e) {
				if (e.key === 'Enter') {
					confirmQuantity.click();
				}
			});
		});

		document.addEventListener('DOMContentLoaded', function () {
			document.querySelectorAll('form[action$="/giohang/xoa"]').forEach(form => {
				form.addEventListener('submit', function (e) {
					e.preventDefault();
					const tr = form.closest('tr');
					const formData = new FormData(form);
					fetch(form.action, { method: 'POST', body: formData })
						.then(res => {
							if (res.ok) {
								tr.classList.add('fade-out-row');
								setTimeout(() => {
									fetch('/banhangtaiquay/cart-fragment', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
										.then(r => r.text())
										.then(html => {
											document.getElementById('cart-area').innerHTML = html;
											rebindCartDeleteEvents();
											updateDiscountSummary();
										});
									showErrorToast('Đã xóa khỏi giỏ!');
								}, 500);
							} else {
								showErrorToast('Xóa khỏi giỏ thất bại!');
							}
						})
						.catch(() => showErrorToast('Lỗi kết nối!'));
				});
			});
		});

		// Toast function
		function showErrorToast(msg) {
			const toastMsg = document.getElementById('errorToastMsg');
			toastMsg.textContent = msg;
			const toastEl = document.getElementById('errorToast');
			const toast = new bootstrap.Toast(toastEl);
			toast.show();
		}

		document.addEventListener('DOMContentLoaded', function () {
			const productListArea = document.getElementById('product-list-area');
			if (productListArea) {
				productListArea.addEventListener('click', function (e) {
					const link = e.target.closest('a.page-link');
					if (link && link.getAttribute('href')) {
						e.preventDefault();
						productListArea.style.transition = 'opacity 0.3s';
						productListArea.style.opacity = 0;
						fetch(link.getAttribute('href'))
							.then(res => res.text())
							.then(html => {
								const temp = document.createElement('div');
								temp.innerHTML = html;
								const newArea = temp.querySelector('#product-list-area');
								setTimeout(() => {
									if (newArea) {
										productListArea.innerHTML = newArea.innerHTML;
										productListArea.style.opacity = 0;
										setTimeout(() => { productListArea.style.opacity = 1; }, 30);
										rebindProductListEvents();
									}
								}, 300);
							});
					}
				});
			}
		});

		function rebindProductListEvents() {
			document.querySelectorAll('.clickable-card-body').forEach(cardBody => {
				const card = cardBody.closest('.product-card');
				cardBody.onclick = null; cardBody.ondblclick = null;
				cardBody.addEventListener('click', function (e) {
					e.preventDefault();
					e.stopPropagation();
					const danger = card.querySelector('.text-danger');
					if (danger && danger.textContent.includes('Hết hàng')) return;
					if (e.target.closest('form,button,input')) return;
					if (window.clickTimer) clearTimeout(window.clickTimer);
					window.clickTimer = setTimeout(() => {
						card.classList.add('added-animate');
						setTimeout(() => card.classList.remove('added-animate'), 500);
						fetch('/giohang/them', {
							method: 'POST',
							headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
							body: `idSanpham=${cardBody.getAttribute('data-idsanpham')}&soluong=1`
						})
							.then(res => {
								if (res.ok) {
									showErrorToast('Đã thêm vào giỏ!');
									reloadCartFragment(true);
								} else {
									showErrorToast('Thêm vào giỏ thất bại!');
								}
							})
							.catch(() => showErrorToast('Lỗi kết nối!'));
					}, 250);
				});
				cardBody.addEventListener('dblclick', function (e) {
					const danger = card.querySelector('.text-danger');
					if (danger && danger.textContent.includes('Hết hàng')) return;
					if (e.target.closest('form,button,input')) return;
					if (window.clickTimer) clearTimeout(window.clickTimer);
					window.lastForm = form;
					window.lastProductId = idSanpham;
					modalQuantity.value = 1;
					quantityModal.show();
					setTimeout(() => { modalQuantity.focus(); }, 300);
				});
			});
			document.querySelectorAll('.add-to-cart-form').forEach(form => {
				form.onsubmit = null;
				form.addEventListener('submit', function (e) {
					e.preventDefault();
					console.log('AJAX submit add-to-cart', form);
					const formData = new FormData(form);
					fetch(form.action, { method: 'POST', body: formData })
						.then(res => {
							if (res.ok) {
								const card = form.closest('.product-card');
								card.classList.add('added-animate');
								setTimeout(() => card.classList.remove('added-animate'), 500);
								showErrorToast('Đã thêm vào giỏ!');
								if (window.setTotalCartItemsQuantity) window.setTotalCartItemsQuantity(1);
							} else {
								showErrorToast('Thêm vào giỏ thất bại!');
							}
						})
						.catch(() => showErrorToast('Lỗi kết nối!'));
				});
			});
		}

		function reloadCartFragment(withAnimation = false) {
			fetch('/banhangtaiquay/cart-fragment', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
				.then(r => r.text())
				.then(html => {
					const area = document.getElementById('cart-area');
					if (!area) return;
					area.innerHTML = html;
					if (withAnimation) {
						area.querySelectorAll('tr').forEach(tr => {
							tr.classList.add('fade-in-row');
							setTimeout(() => tr.classList.remove('fade-in-row'), 600);
						});
					}
					rebindCartDeleteEvents();
					updateDiscountSummary();
				});
		}

		function rebindCartDeleteEvents() {
			document.querySelectorAll('form[action$="/giohang/xoa"]').forEach(form => {
				form.onsubmit = null;
				form.addEventListener('submit', function (e) {
					e.preventDefault();
					const tr = form.closest('tr');
					const formData = new FormData(form);
					fetch(form.action, { method: 'POST', body: formData })
						.then(res => {
							if (res.ok) {
								tr.classList.add('fade-out-row');
								setTimeout(() => {
									reloadCartFragment();
									showErrorToast('Đã xóa khỏi giỏ!');
								}, 500);
							} else {
								showErrorToast('Xóa khỏi giỏ thất bại!');
							}
						})
						.catch(() => showErrorToast('Lỗi kết nối!'));
				});
			});
		}

		// Gắn lại sự kiện khi trang vừa load
		document.addEventListener('DOMContentLoaded', function () {
			rebindProductListEvents();
			rebindCartDeleteEvents();
		});

		// Tìm kiếm khách hàng theo SĐT
		const searchInput = document.getElementById('searchKhachHangInput');
		const selectedKhachHangId = document.getElementById('selectedKhachHangId');
		let khachHangTimeout = null;
		searchInput.addEventListener('input', function () {
			clearTimeout(khachHangTimeout);
			const sdt = searchInput.value.trim();
			if (!sdt) {
				khachHangResult.innerHTML = '<span class="text-muted">Khách vãng lai</span>';
				selectedKhachHangId.value = '';
				return;
			}
			khachHangResult.innerHTML = '<span class="text-info">Đang tìm...</span>';
			khachHangTimeout = setTimeout(() => {
				fetch(`/api/khachhang/search?sdt=${encodeURIComponent(sdt)}`)
					.then(res => res.json())
					.then(data => {
						if (data && data.idKhachHang) {
							khachHangResult.innerHTML = `<div class='alert alert-success p-2 mb-2'>
								<b>${data.hoten}</b> - ${data.sdt}
								<button class='btn btn-sm btn-outline-primary ms-2' id='chonKhachHangBtn'>Chọn</button>
							</div>`;
							document.getElementById('chonKhachHangBtn').onclick = function () {
								selectedKhachHangId.value = data.idKhachHang;
								khachHangResult.innerHTML = `<span class='text-success'>Đã chọn: <b>${data.hoten}</b> - ${data.sdt}</span>`;
							};
						} else {
							khachHangResult.innerHTML = `<span class='text-danger'>Không tìm thấy khách hàng. Bạn có thể tạo mới.</span>`;
							selectedKhachHangId.value = '';
						}
					})
					.catch(() => {
						khachHangResult.innerHTML = '<span class="text-danger">Lỗi tìm kiếm!</span>';
						selectedKhachHangId.value = '';
					});
			}, 400);
		});
		// Nút tạo khách hàng mới
		document.getElementById('createKhachHangBtn').onclick = function () {
			const modal = new bootstrap.Modal(document.getElementById('createKhachHangModal'));
			document.getElementById('createKhachHangForm').reset();
			modal.show();
		};
		// Submit tạo khách hàng mới
		document.getElementById('createKhachHangForm').onsubmit = function (e) {
			e.preventDefault();
			const formData = new FormData(this);
			fetch('/api/khachhang/create', {
				method: 'POST',
				body: formData
			})
				.then(res => res.json())
				.then(data => {
					if (data && data.idKhachHang) {
						selectedKhachHangId.value = data.idKhachHang;
						khachHangResult.innerHTML = `<span class='text-success'>Đã tạo và chọn: <b>${data.hoten}</b> - ${data.sdt}</span>`;
						bootstrap.Modal.getInstance(document.getElementById('createKhachHangModal')).hide();
						searchInput.value = data.sdt;
					} else {
						alert('Tạo khách hàng thất bại!');
					}
				})
				.catch(() => alert('Lỗi tạo khách hàng!'));
		};

		// Đồng bộ giá trị giảm giá admin vào input ẩn khi submit
		const adminDiscountInput = document.getElementById('adminDiscountInput');
		const adminDiscountHidden = document.getElementById('adminDiscountHidden');
		if (adminDiscountInput && adminDiscountHidden) {
			adminDiscountInput.addEventListener('input', function () {
				adminDiscountHidden.value = adminDiscountInput.value;
			});
			// Đảm bảo giá trị luôn đồng bộ khi submit
			adminDiscountInput.form && adminDiscountInput.form.addEventListener('submit', function () {
				adminDiscountHidden.value = adminDiscountInput.value;
			});
		}

		// Hàm lấy tổng tiền gốc (không tính voucher & giảm giá admin)
		function calcSubtotal() {
			let subtotal = 0;
			document.querySelectorAll('#cart-area tbody tr').forEach(tr => {
				const td = tr.querySelector('td:nth-child(4)');
				if (td && td.textContent && td.textContent.includes('₫')) {
					let val = td.textContent.replace(/[^\d]/g, '');
					if (!isNaN(val)) subtotal += parseInt(val);
				}
			});
			return subtotal;
		}

		let currentVoucher = null; // { code, discountAmount, remainingGlobal, remainingUser }

		// Cập nhật hiển thị tổng hợp giảm giá (admin + voucher)
		function updateDiscountSummary() {
			// Lấy tổng tiền trước giảm từ DOM
			let tongTienTruocGiam = calcSubtotal();
			// Lấy loại khách hàng
			let discountPercent = 0;
			let loaiKh = '';
			let totalQuantity = 0;
			document.querySelectorAll('#cart-area tbody tr').forEach(tr => {
				const tdQty = tr.querySelector('td:nth-child(2)');
				if (tdQty) totalQuantity += parseInt(tdQty.textContent || '0');
			});
			// Lấy loại khách hàng từ kết quả tìm kiếm (nếu có)
			if (window.khachHangResultData && window.khachHangResultData.phanLoai) {
				loaiKh = window.khachHangResultData.phanLoai.toLowerCase();
			}
			// Lấy giảm giá admin nhập
			const adminDiscount = parseInt(document.getElementById('adminDiscountInput').value || '0');
			if (adminDiscount > 0) {
				discountPercent = adminDiscount;
			} else if (loaiKh.includes('vip')) {
				discountPercent = 30;
			} else if (loaiKh.includes('thường') && totalQuantity > 3) {
				discountPercent = 10;
			}
			let tongGiamAdmin = Math.round(tongTienTruocGiam * discountPercent / 100);
			let voucherGiam = 0;
			if (currentVoucher) {
				voucherGiam = Math.min(currentVoucher.discountAmount || 0, tongTienTruocGiam - tongGiamAdmin);
			}
			const tongGiam = tongGiamAdmin + voucherGiam;
			const tongTienSauGiam = Math.max(0, tongTienTruocGiam - tongGiam);
			const tongGiamEl = document.getElementById('tongGiam');
			const tongTienSauGiamEl = document.getElementById('tongTienSauGiam');
			if (tongGiamEl) {
				let extra = '';
				if (currentVoucher) extra = ` + Voucher: ${voucherGiam.toLocaleString()}₫`;
				tongGiamEl.textContent = tongGiam.toLocaleString() + '₫ (' + discountPercent + '%)' + extra;
			}
			if (tongTienSauGiamEl) tongTienSauGiamEl.textContent = tongTienSauGiam.toLocaleString() + '₫';

			// Cập nhật discount từng sản phẩm
			document.querySelectorAll('#cart-area tbody tr').forEach(tr => {
				const discountCell = tr.querySelector('.discount-cell');
				if (discountCell) {
					tr.classList.remove('row-highlight');
					setTimeout(() => tr.classList.add('row-highlight'), 10);
					setTimeout(() => tr.classList.remove('row-highlight'), 1200);
					discountCell.textContent = discountPercent + '%';
				}
			});
		}
		// Gọi lại hàm này khi thay đổi giỏ, khách hàng, hoặc giảm giá
		document.getElementById('adminDiscountInput').addEventListener('input', updateDiscountSummary);
		window.khachHangResultData = {};
		var khachHangResult = document.getElementById('khachHangResult');
		if (khachHangResult) {
			const observer = new MutationObserver(updateDiscountSummary);
			observer.observe(khachHangResult, { childList: true, subtree: true });
		}
		// Gọi lần đầu khi trang load
		updateDiscountSummary();

		// ===== Voucher Handling =====
		const voucherInput = document.getElementById('voucherCodeInput');
		const applyVoucherBtn = document.getElementById('applyVoucherBtn');
		const removeVoucherBtn = document.getElementById('removeVoucherBtn');
		const voucherFeedback = document.getElementById('voucherFeedback');
		const voucherCodeHidden = document.getElementById('voucherCodeHidden');
		const voucherDiscountHidden = document.getElementById('voucherDiscountHidden');

		function setVoucherFeedback(msg, type = 'muted') {
			voucherFeedback.className = 'small mt-1 text-' + type;
			voucherFeedback.textContent = msg;
		}

		function validateVoucher() {
			const code = voucherInput.value.trim();
			if (!code) { setVoucherFeedback(''); return; }
			setVoucherFeedback('Đang kiểm tra...', 'info');
			const subtotal = calcSubtotal();
			if (subtotal <= 0) { setVoucherFeedback('Giỏ hàng trống', 'warning'); return; }
			// userId: lấy khách hàng chọn, fallback user ADMIN? dùng selectedKhachHangId hoặc 'anonymous'
			const userId = document.getElementById('selectedKhachHangId').value || 'anonymous';
			fetch(`/api/vouchers/validate?code=${encodeURIComponent(code)}&subtotal=${subtotal}&userId=${encodeURIComponent(userId)}`)
				.then(res => res.json().then(j => ({ ok: res.ok, body: j })))
				.then(({ ok, body }) => {
					if (!ok || body.error) {
						currentVoucher = null;
						voucherCodeHidden.value = ''; voucherDiscountHidden.value = '';
						setVoucherFeedback(body.error || 'Voucher không hợp lệ', 'danger');
						removeVoucherBtn.classList.add('d-none');
						return;
					}
					currentVoucher = body;
					voucherCodeHidden.value = body.code;
					voucherDiscountHidden.value = body.discountAmount;
					setVoucherFeedback(`Giảm ${body.discountAmount.toLocaleString()}₫ - Còn lại: ${body.remainingGlobal ?? '∞'} / ${body.remainingUser ?? '∞'}`, 'success');
					removeVoucherBtn.classList.remove('d-none');
					updateDiscountSummary();
				})
				.catch(() => {
					setVoucherFeedback('Lỗi kiểm tra voucher', 'danger');
				});
		}

		applyVoucherBtn.addEventListener('click', validateVoucher);
		voucherInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); validateVoucher(); } });
		removeVoucherBtn.addEventListener('click', () => {
			currentVoucher = null;
			voucherCodeHidden.value = ''; voucherDiscountHidden.value = '';
			voucherInput.value = '';
			removeVoucherBtn.classList.add('d-none');
			setVoucherFeedback('Đã bỏ voucher', 'secondary');
			updateDiscountSummary();
		});
	</script>

	<!-- Toast notification -->
	<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
		<div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert"
			aria-live="assertive" aria-atomic="true">
			<div class="d-flex">
				<div class="toast-body" id="errorToastMsg">
					Số lượng vượt quá tồn kho!
				</div>
				<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
					aria-label="Close"></button>
			</div>
		</div>
	</div>

</body>

</html>