<!DOCTYPE html>
<html lang="vi">

<head>
  <th:block th:replace="~{user/_meta}" />
  <title th:text="'Thông tin đơn hàng #' + ${order.idHoadon}"></title>
</head>

<body class="bg-light">
  <th:block th:replace="~{admin/_headerAdmin}" class="no-print" />

  <div class="container-fluid px-4 py-4">
    <!-- PRINT HEADER (only when printing) -->
    <div class="d-none d-print-block invoice-print-header">
      <div class="d-flex align-items-start justify-content-between mb-2">
        <div class="d-flex align-items-center gap-3">
          <img src="/static/img/favicon.ico" alt="Logo" class="invoice-logo" />
          <div>
            <h3 class="m-0" th:text="${storeName}"></h3>
            <div class="small" th:text="${storeAddress}"></div>
            <div class="small">ĐT: <span th:text="${storePhone}"></span></div>
          </div>
        </div>
        <div class="text-end">
          <div class="fw-semibold">HÓA ĐƠN BÁN HÀNG</div>
          <div>Mã: #<span th:text="${order.idHoadon}"></span></div>
          <div>Ngày: <span th:text="${#dates.format(order.ngaytao, 'dd/MM/yyyy HH:mm')}"></span></div>
        </div>
      </div>
      <hr />
    </div>

    <!-- PAGE HEADER -->
    <div class="d-flex flex-wrap gap-3 align-items-center mb-4 no-print">
      <div>
        <h5 class="mb-1">Đơn hàng #<span th:text="${order.idHoadon}"></span></h5>
        <div class="text-muted-sm">Chi tiết thông tin đơn hàng</div>
      </div>
      <div class="ms-auto d-flex gap-2">
        <a th:href="@{/admin/hoadon}" class="btn btn-soft-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i>Quay
          lại</a>
        <a th:href="@{/admin/hoadon/print/{id}(id=${order.idHoadon})}" target="_blank"
          class="btn btn-soft-primary btn-sm"><i class="fas fa-print me-1"></i>In hóa đơn</a>
      </div>
    </div>

    <div class="row g-4">
      <!-- LEFT: Order Meta -->
      <div class="col-lg-4">
        <div class="card-elevated p-3 h-100">
          <div class="mb-3">
            <div class="form-section-title mb-2">Trạng thái & Thanh toán</div>
            <div class="d-flex flex-wrap gap-2">
              <span th:if="${order.trangthai == 'ondelivery'}" class="status-badge status-ondelivery"><i
                  class="fas fa-truck"></i> Đang giao</span>
              <span th:if="${order.trangthai == 'received'}" class="status-badge status-received"><i
                  class="fas fa-check"></i> Hoàn tất</span>
              <span th:if="${order.trangthai == 'cancel'}" class="status-badge status-cancel"><i
                  class="fas fa-times"></i> Hủy</span>
            </div>
          </div>
          <div class="divider"></div>
          <div class="mb-3">
            <div class="form-section-title">Ngày tạo</div>
            <div class="fw-semibold" th:text="${#dates.format(order.ngaytao, 'dd/MM/yyyy')}"></div>
          </div>
          <div class="mb-3">
            <div class="form-section-title">Nhân viên tạo đơn</div>
            <a class="text-decoration-none fw-semibold" th:text="${order.users.hoten}"
              th:href="@{/admin/user/edit/{id}(id=${order.users.idUser})}"></a>
          </div>
          <div class="mb-3">
            <div class="form-section-title">Giảm giá áp dụng</div>
            <div th:if="${order.discountAmount != null}" class="d-flex align-items-center gap-2 flex-wrap">
              <span class="badge-soft-success badge-rounded badge-xs d-inline-flex align-items-center gap-1 discount-inline">
                <i class="fas fa-percent"></i>
                <span class="text-danger">-</span>
                <span th:text="${#numbers.formatInteger(order.discountAmount,0,'COMMA')}"></span>
                <span>&nbsp;₫</span>
              </span>
            </div>
            <div th:if="${order.discountAmount == null}" class="text-muted">Không áp dụng</div>
          </div>
          <div class="mb-3" th:if="${order.voucherCode != null}">
            <div class="form-section-title">Voucher</div>
            <span class="badge-soft-primary badge-rounded badge-xs"><i class="fas fa-ticket-alt me-1"></i><span
                th:text="${order.voucherCode}"></span></span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Items -->
      <div class="col-lg-8">
        <div class="card-elevated p-3">
          <div class="d-flex align-items-center mb-2">
            <div class="form-section-title mb-0">Chi tiết sản phẩm</div>
          </div>
          <div class="table-responsive">
            <table class="table table-modern table-compact align-middle mb-0 invoice-items">
              <thead>
                <tr>
                  <th style="width: 40%;">Sản phẩm</th>
                  <th class="text-center" style="width: 8%;">SL</th>
                  <th class="text-end" style="width: 14%;">Giá gốc</th>
                  <th class="text-end" style="width: 10%;">Giảm %</th>
                  <th class="text-end" style="width: 14%;">Giá áp dụng</th>
                  <th class="text-end" style="width: 14%;">Thành tiền</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="sanpham : ${listSanPham}" th:with="unitPrice=${sanpham.gia * (100 - sanpham.giamgia)/100}">
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <img width="42" height="42" class="rounded" th:src="@{/image/{url}(url=${sanpham.hinh})}" th:alt="${sanpham.tenSanpham}" />
                      <a th:href="@{/admin/sanpham/edit/{id}(id=${sanpham.idSanpham})}" class="text-decoration-none fw-semibold" th:text="${sanpham.tenSanpham}"></a>
                    </div>
                  </td>
                  <td class="text-center" th:text="${sanpham.soluong}"></td>
                  <td class="text-end"><span th:text="${#numbers.formatInteger(sanpham.gia,0,'COMMA')}"></span><span>&nbsp;₫</span></td>
                  <td class="text-end">
                    <span th:if="${sanpham.giamgia > 0}" th:text="${sanpham.giamgia + '%'}" class="text-danger fw-semibold"></span>
                    <span th:if="${sanpham.giamgia == 0}" class="text-muted">-</span>
                  </td>
                  <td class="text-end">
                    <span th:text="${#numbers.formatInteger(unitPrice,0,'COMMA')}"></span><span>&nbsp;₫</span>
                  </td>
                  <td class="text-end">
                    <span th:text="${#numbers.formatInteger(unitPrice * sanpham.soluong,0,'COMMA')}"></span><span>&nbsp;₫</span>
                  </td>
                </tr>
              </tbody>
              <tfoot th:with="subtotal=${tempPrice}, 
                                 totalDiscount=${order.discountAmount != null ? order.discountAmount : 0}, 
                                 voucherDiscount=${order.voucherDiscountAmount != null ? order.voucherDiscountAmount : 0}, 
                                 finalTotal=${subtotal - totalDiscount - voucherDiscount}">
                <tr class="border-top">
                  <td colspan="5" class="text-end"><strong>Tạm tính</strong></td>
                  <td class="text-end"><span th:text="${#numbers.formatInteger(subtotal, 0, 'COMMA')}"></span><span>&nbsp;₫</span></td>
                </tr>
                <tr>
                  <td colspan="5" class="text-end"><strong>Giảm giá</strong></td>
                  <td class="text-end text-danger">
                    <span th:if="${totalDiscount > 0}" class="text-danger">-</span><span th:if="${totalDiscount > 0}" th:text="${#numbers.formatInteger(totalDiscount,0,'COMMA')}"></span><span th:if="${totalDiscount > 0}">&nbsp;₫</span>
                    <span th:if="${totalDiscount == 0}">-</span>
                  </td>
                </tr>
                <tr th:if="${order.voucherDiscountAmount != null}">
                  <td colspan="5" class="text-end"><strong>Voucher</strong></td>
                  <td class="text-end text-danger"><span class="text-danger">-</span><span th:text="${#numbers.formatInteger(order.voucherDiscountAmount,0,'COMMA')}"></span><span>&nbsp;₫</span></td>
                </tr>
                <tr>
                  <td colspan="5" class="text-end"><strong>Phí giao hàng</strong></td>
                  <td class="text-end"><span th:text="${#numbers.formatInteger(deliveryPrice != null ? deliveryPrice : 0,0,'COMMA')}"></span><span>&nbsp;₫</span></td>
                </tr>
                <tr class="table-active">
                  <td colspan="5" class="text-end"><strong>Thành tiền</strong></td>
                  <td class="text-end fw-bold"><span th:text="${#numbers.formatInteger(finalTotal + (deliveryPrice != null ? deliveryPrice : 0),0,'COMMA')}"></span><span>&nbsp;₫</span></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <th:block th:replace="~{admin/_footerAdmin}" />

  <link rel="stylesheet" href="/static/css/vietnamese-fonts.css">

  <script>
    document.getElementById("xuatHoaDon")?.addEventListener("click", function () {
      window.print();
    });
  </script>

  <style>
    .card {
      border-radius: 0.5rem;
    }

    .table> :not(caption)>*>* {
      padding: 1rem 0;
    }

    .badge {
      padding: 0.5rem 0.75rem;
      font-weight: 500;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      font-weight: 500;
    }

    img {
      object-fit: cover;
    }

    @media print {

      .no-print,
      .no-print * {
        display: none !important;
      }

      body,
      .container-fluid {
        background: #fff !important;
        color: #000 !important;
        font-size: 14px;
        font-family: 'Segoe UI', 'Arial Unicode MS', 'DejaVu Sans', 'Times New Roman', Arial, sans-serif !important;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .container-fluid {
        padding: 2rem !important;
        max-width: 700px;
        margin: 0 auto;
      }

      .card {
        box-shadow: none !important;
        margin: 0 !important;
        border: none !important;
      }

      .badge {
        border: 1px solid #dee2e6;
      }

      img {
        max-width: 60px;
        max-height: 60px;
      }

      h3,
      h5,
      strong {
        font-weight: bold;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border: 1px solid #dee2e6;
        padding: 8px;
      }

      thead th {
        background: #f8f9fa !important;
      }

      tfoot td {
        font-weight: bold;
      }

      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
    }

    .invoice-print-header .invoice-logo {
      height: 58px;
      width: 58px;
      object-fit: contain;
    }

    .invoice-items th,
    .invoice-items td {
      padding: 0.4rem 0.5rem !important;
    }

    .invoice-items tfoot td {
      font-weight: 600;
    }

    @media print {
      .invoice-items tfoot tr.table-active {
        background: #f2f4f7 !important;
      }

      .invoice-items img {
        border: 1px solid #ddd;
      }
    }
  </style>
</body>

</html>